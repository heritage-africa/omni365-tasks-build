name: Release

on:
  push:
    tags: ['*']

permissions:
  contents: write

jobs:
  release:
    # Trigger only if the tag name starts with "v"
    if: startsWith(github.ref_name, 'v')
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------------------------
      # Checkout code 
      # ---------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # ---------------------------------------------------------
      # üî¢ Read Node/NPM versions
      # ---------------------------------------------------------
      - name: Read node & npm versions
        id: versions
        uses: skjnldsv/read-package-engines-version-actions@v3
        with:
          fallbackNode: '^20'
          fallbackNpm: '^10'

      # ---------------------------------------------------------
      # ‚öôÔ∏è Setup Nextcloud environment + Krankerl
      # ---------------------------------------------------------
      - name: Setup Nextcloud environment
        uses: ChristophWurst/setup-nextcloud@v0.3.2
        with:
          node-version: ${{ steps.versions.outputs.nodeVersion }}
          npm-version: ${{ steps.versions.outputs.npmVersion }}
          tools: "krankerl"

      # ---------------------------------------------------------
      # üì¶ Install dependencies & build
      # ---------------------------------------------------------
      - name: Install dependencies & build
        env:
          CYPRESS_INSTALL_BINARY: 0
          PUPPETEER_SKIP_DOWNLOAD: true
        run: |
          npm ci
          npm run build --if-present

      # ---------------------------------------------------------
      # üóúÔ∏è Package app with Krankerl
      # ---------------------------------------------------------
      - name: Package app
        run: krankerl package

      # ---------------------------------------------------------
      # üöÄ Create GitHub Release & upload tar.gz
      # ---------------------------------------------------------
      - name: Create GitHub Release
        env: 
          GH_TOKEN: ${{ secrets.DEVOPS }}
        run: |
          gh release create "$GITHUB_REF_NAME" \
            --title "Release $GITHUB_REF_NAME" \
            --notes "Automated release" \
            ./build/artifacts/tasks.tar.gz
